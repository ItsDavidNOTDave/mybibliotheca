{% extends "base.html" %}
{% block title %}Edit Book - Bibliotheca{% endblock %}

{% block extra_head %}
<style>
.contributor-autocomplete {
    position: relative;
}
.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.1s ease;
}
.autocomplete-item:hover,
.autocomplete-item.selected {
    background-color: #f8f9fa;
}
.autocomplete-item:last-child {
    border-bottom: none;
}
.autocomplete-item .name {
    font-weight: 500;
    color: #212529;
}
.autocomplete-item .bio {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
    max-height: 2.4em;
    overflow: hidden;
    line-height: 1.2;
}
.autocomplete-item.create-new {
    background-color: #f8f9fa;
    border-top: 2px solid #dee2e6;
    color: #198754;
}
.autocomplete-item.create-new:hover {
    background-color: #e9f7ef;
}
.contributor-tag {
    display: inline-block;
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-radius: 16px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875em;
}
.contributor-tag .remove {
    color: #dc3545;
    cursor: pointer;
    margin-left: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">Edit Book</h1>
                <a href="{{ url_for('main.view_book', uid=book.uid) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Book
                </a>
            </div>
        </div>
    </div>
    
    <form method="post" id="editBookForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
            <!-- Basic Information -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ book.title }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="subtitle" class="form-label">Subtitle</label>
                            <input type="text" class="form-control" id="subtitle" name="subtitle" value="{{ book.subtitle or '' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="4">{{ book.description or '' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="isbn13" class="form-label">ISBN-13</label>
                                    <input type="text" class="form-control" id="isbn13" name="isbn13" value="{{ book.isbn13 or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="isbn10" class="form-label">ISBN-10</label>
                                    <input type="text" class="form-control" id="isbn10" name="isbn10" value="{{ book.isbn10 or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="published_date" class="form-label">Published Date</label>
                                    <input type="text" class="form-control" id="published_date" name="published_date" 
                                           value="{{ book.published_date or '' }}" placeholder="YYYY or YYYY-MM-DD">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="page_count" class="form-label">Page Count</label>
                                    <input type="number" class="form-control" id="page_count" name="page_count" value="{{ book.page_count or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="publisher" class="form-label">Publisher</label>
                                    <input type="text" class="form-control" id="publisher" name="publisher" 
                                           value="{{ book.publisher.name if book.publisher and book.publisher.name else book.publisher or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language" class="form-label">Language</label>
                                    <input type="text" class="form-control" id="language" name="language" value="{{ book.language or 'en' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contributors -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Contributors</h5>
                    </div>
                    <div class="card-body">
                        <!-- Authors -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-person-fill"></i> Authors
                            </label>
                            <div class="contributor-section" data-type="authored">
                                <div class="contributors-display mb-2">
                                    {% for author in book.authors %}
                                    <div class="contributor-tag" data-id="{{ author.id or '' }}" data-name="{{ author.name }}">
                                        {{ author.name }}
                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="contributor-autocomplete">
                                    <input type="text" class="form-control contributor-input" 
                                           placeholder="Start typing author name..." data-type="authored">
                                    <div class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Narrators -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-headphones"></i> Narrators
                            </label>
                            <div class="contributor-section" data-type="narrated">
                                <div class="contributors-display mb-2">
                                    {% for narrator in book.narrators %}
                                    <div class="contributor-tag" data-id="{{ narrator.id or '' }}" data-name="{{ narrator.name }}">
                                        {{ narrator.name }}
                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="contributor-autocomplete">
                                    <input type="text" class="form-control contributor-input" 
                                           placeholder="Start typing narrator name..." data-type="narrated">
                                    <div class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Editors -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-pencil"></i> Editors
                            </label>
                            <div class="contributor-section" data-type="edited">
                                <div class="contributors-display mb-2">
                                    {% for editor in book.editors %}
                                    <div class="contributor-tag" data-id="{{ editor.id or '' }}" data-name="{{ editor.name }}">
                                        {{ editor.name }}
                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="contributor-autocomplete">
                                    <input type="text" class="form-control contributor-input" 
                                           placeholder="Start typing editor name..." data-type="edited">
                                    <div class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other Contributors -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-people"></i> Other Contributors
                            </label>
                            <div class="contributor-section" data-type="contributed">
                                <div class="contributors-display mb-2">
                                    {% for contributor in book.get_contributors_by_type('CONTRIBUTED') %}
                                    <div class="contributor-tag" data-id="{{ contributor.id or '' }}" data-name="{{ contributor.name }}">
                                        {{ contributor.name }}
                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="contributor-autocomplete">
                                    <input type="text" class="form-control contributor-input" 
                                           placeholder="Start typing contributor name..." data-type="contributed">
                                    <div class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden inputs for contributors -->
        <div id="contributorInputs"></div>
        
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                    <a href="{{ url_for('main.view_book', uid=book.uid) }}" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// JavaScript loaded for edit_book_enhanced.html

let searchTimeout;
let activeDropdown = null;

// Initialize contributor autocomplete
document.addEventListener('DOMContentLoaded', function() {
    const contributorInputs = document.querySelectorAll('.contributor-input');
    
    contributorInputs.forEach((input, index) => {
        input.addEventListener('input', handleInput);
        input.addEventListener('keydown', handleKeydown);
        input.addEventListener('blur', handleBlur);
    });
    
    // Update hidden inputs on form submission
    const form = document.getElementById('editBookForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            updateHiddenInputs();
        });
    }
    
    // Update hidden inputs on page load
    updateHiddenInputs();
});

function handleInput(e) {
    const input = e.target;
    const query = input.value.trim();
    const dropdown = input.nextElementSibling;
    
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (query.length < 2) {
        hideDropdown(dropdown);
        return;
    }
    
    // Reduced timeout for more responsive search
    searchTimeout = setTimeout(() => {
        searchPersons(query, dropdown, input);
    }, 150);
}

function handleKeydown(e) {
    const dropdown = e.target.nextElementSibling;
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const selected = dropdown.querySelector('.autocomplete-item.selected');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const next = selected.nextElementSibling || items[0];
            next.classList.add('selected');
        } else if (items.length > 0) {
            items[0].classList.add('selected');
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const prev = selected.previousElementSibling || items[items.length - 1];
            prev.classList.add('selected');
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selected) {
            selectPerson(selected);
        } else {
            // Create new person
            createNewPerson(e.target);
        }
    } else if (e.key === 'Escape') {
        hideDropdown(dropdown);
    }
}

function handleBlur(e) {
    // Delay hiding to allow click on dropdown items
    setTimeout(() => {
        const dropdown = e.target.nextElementSibling;
        hideDropdown(dropdown);
    }, 200);
}

function searchPersons(query, dropdown, input) {
    // Show loading indicator
    dropdown.innerHTML = `
        <div class="autocomplete-item">
            <div class="name text-muted">
                <i class="bi bi-hourglass-split"></i> Searching...
            </div>
        </div>
    `;
    dropdown.style.display = 'block';
    
    fetch(`/api/person/search?q=${encodeURIComponent(query)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(persons => {
            showDropdown(dropdown, persons, input);
        })
        .catch(error => {
            console.error('Error searching persons:', error);
            // Show create option if search fails
            showDropdown(dropdown, [], input);
        });
}

function showDropdown(dropdown, persons, input) {
    if (!dropdown) {
        return;
    }
    
    dropdown.innerHTML = '';
    
    // Show existing persons
    persons.forEach((person, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `
            <div class="name">${person.name}</div>
            ${person.bio ? `<div class="bio">${person.bio}</div>` : ''}
            ${person.book_count > 0 ? `<div class="bio text-muted">${person.book_count} book${person.book_count > 1 ? 's' : ''}</div>` : ''}
        `;
        item.dataset.id = person.id;
        item.dataset.name = person.name;
        item.addEventListener('mousedown', () => selectPerson(item));
        dropdown.appendChild(item);
    });
    
    // Add "Create new" option at the bottom if query exists
    if (input.value.trim()) {
        const createItem = document.createElement('div');
        createItem.className = 'autocomplete-item create-new';
        createItem.innerHTML = `
            <div class="name">
                <i class="bi bi-plus-circle me-1"></i> 
                Add "${input.value.trim()}" as new person
            </div>
        `;
        createItem.dataset.name = input.value.trim();
        createItem.dataset.new = 'true';
        createItem.addEventListener('mousedown', () => selectPerson(createItem));
        dropdown.appendChild(createItem);
    }
    
    dropdown.style.display = 'block';
    activeDropdown = dropdown;
}

function hideDropdown(dropdown) {
    dropdown.style.display = 'none';
    dropdown.innerHTML = '';
    activeDropdown = null;
}

function selectPerson(item) {
    const input = item.closest('.contributor-autocomplete').querySelector('.contributor-input');
    const section = input.closest('.contributor-section');
    const display = section.querySelector('.contributors-display');
    
    let personId = item.dataset.id || '';
    const personName = item.dataset.name;
    const isNew = item.dataset.new === 'true';
    
    // If this is a new person, we'll handle creation during form submission
    // For now, just add it to the UI without an ID
    if (isNew) {
        personId = ''; // Will be created when form is submitted
    }
    
    // Check if person is already added
    const existingTags = display.querySelectorAll('.contributor-tag');
    for (let tag of existingTags) {
        if (tag.dataset.name === personName) {
            input.value = '';
            hideDropdown(item.closest('.autocomplete-dropdown'));
            return; // Person already added
        }
    }
    
    // Add contributor tag
    const tag = document.createElement('div');
    tag.className = 'contributor-tag';
    tag.dataset.id = personId;
    tag.dataset.name = personName;
    tag.dataset.new = isNew ? 'true' : 'false';
    tag.innerHTML = `
        ${personName}
        ${isNew ? '<small class="text-muted"> (new)</small>' : ''}
        <span class="remove" onclick="removeContributor(this)">×</span>
    `;
    
    display.appendChild(tag);
    
    // Clear input
    input.value = '';
    hideDropdown(item.closest('.autocomplete-dropdown'));
    
    // Update hidden inputs
    updateHiddenInputs();
}

function createNewPerson(input) {
    const name = input.value.trim();
    if (!name) return;
    
    selectPerson({
        dataset: { name: name },
        closest: () => input.closest('.contributor-autocomplete').querySelector('.contributor-input')
    });
}

function removeContributor(removeBtn) {
    const contributorTag = removeBtn.closest('.contributor-tag');
    
    if (contributorTag) {
        contributorTag.remove();
        updateHiddenInputs();
    }
}

function updateHiddenInputs() {
    const hiddenContainer = document.getElementById('contributorInputs');
    hiddenContainer.innerHTML = '';
    
    const sections = document.querySelectorAll('.contributor-section');
    let contributorIndex = 0;
    
    sections.forEach((section, sectionIndex) => {
        const type = section.dataset.type;
        const tags = section.querySelectorAll('.contributor-tag');
        
        tags.forEach((tag, tagIndex) => {
            const id = tag.dataset.id;
            const name = tag.dataset.name;
            const isNew = tag.dataset.new === 'true';
            
            // Create hidden inputs for this contributor
            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = `contributors[${contributorIndex}][type]`;
            typeInput.value = type;
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = `contributors[${contributorIndex}][name]`;
            nameInput.value = name;
            
            const isNewInput = document.createElement('input');
            isNewInput.type = 'hidden';
            isNewInput.name = `contributors[${contributorIndex}][is_new]`;
            isNewInput.value = isNew ? 'true' : 'false';
            
            if (id && !isNew) {
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = `contributors[${contributorIndex}][id]`;
                idInput.value = id;
                hiddenContainer.appendChild(idInput);
            }
            
            hiddenContainer.appendChild(typeInput);
            hiddenContainer.appendChild(nameInput);
            hiddenContainer.appendChild(isNewInput);
            
            contributorIndex++;
        });
    });
}
</script>
{% endblock %}
